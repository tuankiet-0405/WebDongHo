<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết đơn hàng | CHRONOS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Sora:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #070A12;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { dark: '#070A12', navy: '#0B1020', gold: '#D6B25E', cyan: '#22D3EE', offwhite: '#EAEAF0', muted: '#9AA3B2' }, fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Sora', 'sans-serif'], mono: ['Space Grotesk', 'monospace'] } } } }
    </script>
</head>

<body class="bg-dark text-offwhite font-sans antialiased">
    <%- include('../partials/header') %>

        <section class="pt-32 pb-8 bg-navy">
            <div class="container mx-auto px-6">
                <div class="flex items-center gap-4 mb-4">
                    <a href="/users/orders" class="text-muted hover:text-gold transition-colors">
                        <iconify-icon icon="lucide:arrow-left" width="20"></iconify-icon>
                    </a>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-display font-semibold text-white">Đơn hàng <%=
                                order.orderNumber %>
                        </h1>
                        <p class="text-muted mt-1">Đặt ngày <%= new Date(order.createdAt).toLocaleDateString('vi-VN') %>
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-12 bg-dark min-h-[60vh]">
            <div class="container mx-auto px-6">
                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- Main Content -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Products -->
                        <div class="glass-panel rounded-xl p-6">
                            <h2 class="text-lg font-display font-medium text-white mb-6 flex items-center gap-2">
                                <iconify-icon icon="lucide:package" class="text-gold"></iconify-icon>
                                Sản phẩm đã đặt
                            </h2>
                            <div class="space-y-4">
                                <% order.items.forEach(item=> { %>
                                    <div class="flex gap-4 pb-4 border-b border-white/10 last:border-0 last:pb-0">
                                        <div class="w-24 h-24 bg-navy rounded-lg overflow-hidden flex-shrink-0">
                                            <img src="<%= item.image %>" alt="<%= item.name %>"
                                                class="w-full h-full object-contain p-2">
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-white font-medium mb-1">
                                                <%= item.name %>
                                            </h3>
                                            <p class="text-muted text-sm mb-2">Số lượng: <%= item.quantity %>
                                            </p>
                                            <p class="text-gold font-mono font-medium">
                                                <%= item.price.toLocaleString('vi-VN') %>₫
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-white font-mono font-medium">
                                                <%= item.subtotal.toLocaleString('vi-VN') %>₫
                                            </p>
                                        </div>
                                    </div>
                                    <% }); %>
                            </div>

                            <!-- Order Summary -->
                            <div class="mt-6 pt-6 border-t border-white/10 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-muted">Tạm tính</span>
                                    <span class="text-white">
                                        <%= order.itemsTotal.toLocaleString('vi-VN') %>₫
                                    </span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-muted">Phí vận chuyển</span>
                                    <span class="text-white">
                                        <%= order.shippingFee.toLocaleString('vi-VN') %>₫
                                    </span>
                                </div>
                                <% if (order.discount> 0) { %>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-green-400">Giảm giá <% if (order.couponCode) { %>(<%=
                                                    order.couponCode %>)<% } %></span>
                                        <span class="text-green-400">-<%= order.discount.toLocaleString('vi-VN') %>
                                                ₫</span>
                                    </div>
                                    <% } %>
                                        <div class="h-px bg-white/10"></div>
                                        <div class="flex justify-between">
                                            <span class="text-white font-medium">Tổng cộng</span>
                                            <span class="text-2xl font-mono font-bold text-gold">
                                                <%= order.totalAmount.toLocaleString('vi-VN') %>₫
                                            </span>
                                        </div>
                            </div>
                        </div>

                        <!-- Order Timeline -->
                        <div class="glass-panel rounded-xl p-6">
                            <h2 class="text-lg font-display font-medium text-white mb-6 flex items-center gap-2">
                                <iconify-icon icon="lucide:clock" class="text-gold"></iconify-icon>
                                Lịch sử đơn hàng
                            </h2>
                            <div class="space-y-4">
                                <% if (order.statusHistory && order.statusHistory.length> 0) { %>
                                    <% order.statusHistory.slice().reverse().forEach((history, index)=> { %>
                                        <div class="flex gap-4">
                                            <div class="flex flex-col items-center">
                                                <div
                                                    class="w-3 h-3 rounded-full <%= index === 0 ? 'bg-gold' : 'bg-white/20' %>">
                                                </div>
                                                <% if (index < order.statusHistory.length - 1) { %>
                                                    <div class="w-0.5 h-full bg-white/10 mt-2"></div>
                                                    <% } %>
                                            </div>
                                            <div class="flex-1 pb-6">
                                                <p class="text-white font-medium">
                                                    <% if (history.status==='pending' ) { %>
                                                        Đơn hàng được tạo
                                                        <% } else if (history.status==='confirmed' ) { %>
                                                            Đã xác nhận đơn hàng
                                                            <% } else if (history.status==='processing' ) { %>
                                                                Đang chuẩn bị hàng
                                                                <% } else if (history.status==='shipping' ) { %>
                                                                    Đang giao hàng
                                                                    <% } else if (history.status==='delivered' ) { %>
                                                                        Giao hàng thành công
                                                                        <% } else if (history.status==='cancelled' ) {
                                                                            %>
                                                                            Đơn hàng đã bị hủy
                                                                            <% } %>
                                                </p>
                                                <p class="text-muted text-sm">
                                                    <%= new Date(history.timestamp).toLocaleString('vi-VN') %>
                                                </p>
                                                <% if (history.note) { %>
                                                    <p class="text-muted text-sm mt-1">
                                                        <%= history.note %>
                                                    </p>
                                                    <% } %>
                                            </div>
                                        </div>
                                        <% }); %>
                                            <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Order Status -->
                        <div class="glass-panel rounded-xl p-6">
                            <h2 class="text-lg font-display font-medium text-white mb-4">Trạng thái</h2>
                            <% let statusColor='bg-yellow-500/10 text-yellow-400 border-yellow-500/30' ; let
                                statusText='Chờ xử lý' ; let statusIcon='lucide:clock' ; if (order.status==='confirmed'
                                ) { statusColor='bg-blue-500/10 text-blue-400 border-blue-500/30' ;
                                statusText='Đã xác nhận' ; statusIcon='lucide:check-circle' ; } else if
                                (order.status==='processing' ) {
                                statusColor='bg-cyan-500/10 text-cyan-400 border-cyan-500/30' ; statusText='Đang xử lý'
                                ; statusIcon='lucide:package' ; } else if (order.status==='shipping' ) {
                                statusColor='bg-purple-500/10 text-purple-400 border-purple-500/30' ;
                                statusText='Đang giao hàng' ; statusIcon='lucide:truck' ; } else if
                                (order.status==='delivered' ) {
                                statusColor='bg-green-500/10 text-green-400 border-green-500/30' ;
                                statusText='Đã giao hàng' ; statusIcon='lucide:check-circle-2' ; } else if
                                (order.status==='cancelled' ) {
                                statusColor='bg-red-500/10 text-red-400 border-red-500/30' ; statusText='Đã hủy' ;
                                statusIcon='lucide:x-circle' ; } %>
                                <div class="flex items-center gap-3 p-4 rounded-lg border <%= statusColor %>">
                                    <iconify-icon icon="<%= statusIcon %>" width="24"></iconify-icon>
                                    <span class="font-medium">
                                        <%= statusText %>
                                    </span>
                                </div>

                                <!-- Cancel Button -->
                                <% if (order.status==='pending' || order.status==='confirmed' ) { %>
                                    <button onclick="cancelOrder()"
                                        class="w-full mt-4 bg-red-500/10 hover:bg-red-500/20 text-red-400 font-medium py-3 rounded-lg text-sm border border-red-500/30 transition-colors">
                                        Hủy đơn hàng
                                    </button>
                                    <% } %>
                        </div>

                        <!-- Customer Info -->
                        <div class="glass-panel rounded-xl p-6">
                            <h2 class="text-lg font-display font-medium text-white mb-4 flex items-center gap-2">
                                <iconify-icon icon="lucide:user" class="text-gold"></iconify-icon>
                                Thông tin khách hàng
                            </h2>
                            <div class="space-y-3 text-sm">
                                <div>
                                    <p class="text-muted mb-1">Họ tên</p>
                                    <p class="text-white">
                                        <%= order.customer.name %>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-muted mb-1">Số điện thoại</p>
                                    <p class="text-white">
                                        <%= order.customer.phone %>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-muted mb-1">Email</p>
                                    <p class="text-white">
                                        <%= order.customer.email %>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        <div class="glass-panel rounded-xl p-6">
                            <h2 class="text-lg font-display font-medium text-white mb-4 flex items-center gap-2">
                                <iconify-icon icon="lucide:map-pin" class="text-gold"></iconify-icon>
                                Địa chỉ giao hàng
                            </h2>
                            <p class="text-white text-sm leading-relaxed">
                                <%= order.shippingAddress.address %><br>
                                    <%= order.shippingAddress.ward %>, <%= order.shippingAddress.district %><br>
                                            <%= order.shippingAddress.city %>
                            </p>
                        </div>

                        <!-- Payment Method -->
                        <div class="glass-panel rounded-xl p-6">
                            <h2 class="text-lg font-display font-medium text-white mb-4 flex items-center gap-2">
                                <iconify-icon icon="lucide:credit-card" class="text-gold"></iconify-icon>
                                Thanh toán
                            </h2>
                            <p class="text-white text-sm">
                                <% if (order.paymentMethod==='cod' ) { %>
                                    Thanh toán khi nhận hàng (COD)
                                    <% } else if (order.paymentMethod==='bank' ) { %>
                                        Chuyển khoản ngân hàng
                                        <% } else { %>
                                            <%= order.paymentMethod %>
                                                <% } %>
                            </p>
                            <% let paymentStatusColor='bg-yellow-500/10 text-yellow-400 border-yellow-500/30' ; let
                                paymentStatusText='Chưa thanh toán' ; if (order.paymentStatus==='paid' ) {
                                paymentStatusColor='bg-green-500/10 text-green-400 border-green-500/30' ;
                                paymentStatusText='Đã thanh toán' ; } %>
                                <div class="mt-3 p-2 rounded border text-center text-sm <%= paymentStatusColor %>">
                                    <%= paymentStatusText %>
                                </div>
                        </div>

                        <% if (order.note) { %>
                            <!-- Note -->
                            <div class="glass-panel rounded-xl p-6">
                                <h2 class="text-lg font-display font-medium text-white mb-4 flex items-center gap-2">
                                    <iconify-icon icon="lucide:message-square" class="text-gold"></iconify-icon>
                                    Ghi chú
                                </h2>
                                <p class="text-muted text-sm">
                                    <%= order.note %>
                                </p>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>
        </section>

        <%- include('../partials/footer') %>

            <script>
                async function cancelOrder() {
                    const reason = prompt('Vui lòng nhập lý do hủy đơn:');
                    if (!reason) return;

                    if (!confirm('Bạn có chắc muốn hủy đơn hàng này?')) return;

                    try {
                        const res = await fetch('/orders/<%= order._id %>/cancel', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason })
                        });
                        const data = await res.json();

                        if (data.success) {
                            alert('Đã hủy đơn hàng thành công');
                            location.reload();
                        } else {
                            alert(data.message || 'Có lỗi xảy ra');
                        }
                    } catch (e) {
                        alert('Có lỗi xảy ra');
                    }
                }
            </script>
            <script src="/js/main.js"></script>
</body>

</html>